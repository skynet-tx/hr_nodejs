/**
 * User: osavch
 * Date: 05.11.13
 * Time: 16:37
 * File name:
 */
var hash = require('app_controllers/pass.js').hash,
    _ = require('underscore');

var users = [
    {
        email: 'adm@adm.com',
        hash: 'JYPuR5YKGEIoteFamiA+y0fpBSFAdRP73qcU6sf3EdCvEt5DKmpxOP6pLPjfWRN+S7KserFXZYNTsxxOybgduiEQVUrC0Lc+Vb0Z3o50B/ja21QCDb3zCve2XjJs0y5GxkVlE3lSh5B7fHiZdYdnqJveW8azjSrfJFn8t8Nd4pU=',
        salt: '121212'
    }
];

// Authenticate using our plain-object database of doom!
var AuthController = {
    authenticate: function (email, pass, fn) {
        if (!module.parent) console.log('authenticating %s:%s', email, pass);

        var user = _.find(users, function(obj){
            return obj.email === email.toLowerCase();
        });
        // query the db for the given username
        if (!user) return fn(new Error('cannot find user'));
        // apply the same algorithm to the POSTed password, applying
        // the hash against the pass / salt, if there is a match we
        // found the user

        hash(pass, user.salt, function (err, hash) {
            if (err) return fn(err);
            if (hash == user.hash) return fn(null, user);
            fn(new Error('invalid password'));
        })
    },
    restrict: function (req, res, next) {
        if (req.session.user) {
            next();
        } else {
            req.session.error = 'Access denied!';
            res.redirect('/#login');
        }
    }
};

exports = module.exports = AuthController;
